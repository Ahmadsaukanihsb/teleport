local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")

-- ======= CONFIGURATION =======
local REDIS_API_URL = "https://api-beta-mocha-45.vercel.app/api/getInstanceId"
local PLACE_ID = 126884695634066  -- Ganti dengan game ID yang benar
local CHECK_INTERVAL = 15    -- Detik antara pengecekan
local MAX_ATTEMPTS = 3       -- Maksimal percobaan join per instance
-- =============================

-- Variabel untuk melacak instance terakhir
local lastInstanceId = nil
local isJoining = false

-- Fungsi HTTP yang lebih baik dengan error handling
local function makeHttpRequest()
    local requestFunc = syn and syn.request or http_request or request
    if not requestFunc then
        warn("HTTP request tidak didukung di executor ini")
        return nil
    end
    
    local success, response = pcall(function()
        return requestFunc({
            Url = REDIS_API_URL,
            Method = "GET",
            Headers = {
                ["Content-Type"] = "application/json"
            }
        })
    end)
    
    if not success then
        warn("Gagal melakukan request:", response)
        return nil
    end
    
    return response
end

-- Fungsi untuk mengirim pesan chat
local function sendChatMessage(message)
    -- Coba sistem chat baru (Roblox beta)
    if TextChatService and TextChatService.TextChannels then
        local channel = TextChatService.TextChannels.RBXGeneral
        if channel then
            pcall(function() channel:SendAsync(message) end)
            return
        end
    end
    
    -- Fallback ke sistem chat lama
    local chatEvents = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if chatEvents and chatEvents:FindFirstChild("SayMessageRequest") then
        pcall(function()
            chatEvents.SayMessageRequest:FireServer(message, "All")
        end)
    end
end

-- Fungsi untuk join instance
local function joinInstance(instanceId)
    local attempts = 0
    
    while attempts < MAX_ATTEMPTS and not isJoining do
        attempts = attempts + 1
        isJoining = true
        
        print(`Mencoba join instance {instanceId} (Percobaan {attempts}/{MAX_ATTEMPTS})`)
        
        local success, err = pcall(function()
            TeleportService:TeleportToPlaceInstance(PLACE_ID, instanceId, Players.LocalPlayer)
        end)
        
        isJoining = false
        
        if success then
            -- Tunggu sampai benar-benar terteleport
            local startTime = os.time()
            while os.time() - startTime < 30 do  -- Timeout 30 detik
                if game.JobId == instanceId then
                    print("Berhasil join instance baru!")
                    sendChatMessage("Hello guys!")
                    return true
                end
                wait(1)
            end
            warn("Timeout: Gagal memverifikasi join")
        else
            warn("Gagal teleportasi:", err)
        end
        
        if attempts < MAX_ATTEMPTS then
            wait(5)  -- Tunggu 5 detik sebelum coba lagi
        end
    end
    
    return false
end

-- Fungsi utama loop
local function mainLoop()
    print("Memulai auto joiner loop...")
    
    while true do
        -- Cek instance baru
        local response = makeHttpRequest()
        
        if response and response.StatusCode == 200 then
            local success, data = pcall(HttpService.JSONDecode, HttpService, response.Body)
            
            if success and data and data.instanceId then
                if not lastInstanceId or data.instanceId ~= lastInstanceId then
                    print("Menemukan instance baru:", data.instanceId)
                    
                    if joinInstance(data.instanceId) then
                        lastInstanceId = data.instanceId
                        
                        -- Jalankan script tambahan setelah join
                        -- Contoh: loadstring(game:HttpGet("URL_SCRIPT_LUA"))()
                    else
                        warn("Gagal join instance", data.instanceId)
                    end
                else
                    print("Belum ada instance baru")
                end
            else
                warn("Format response tidak valid")
            end
        else
            warn("Gagal mendapatkan data instance")
        end
        
        wait(CHECK_INTERVAL)
    end
end

-- Jalankan dengan error handling
local success, err = pcall(mainLoop)
if not success then
    warn("Auto joiner error:", err)
    warn("Mencoba restart dalam 30 detik...")
    wait(30)
    pcall(mainLoop)  -- Coba restart
end
