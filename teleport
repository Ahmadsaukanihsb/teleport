local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local placeId = game.PlaceId
local currentInstanceId = tostring(game.JobId)
local apiGetUrl = "https://api-beta-mocha-45.vercel.app/api/getInstanceId"
local apiDeleteUrl = "https://api-beta-mocha-45.vercel.app/api/deleteInstanceId"

-- Fungsi pilih http request
local requestFunction = http_request or request or (syn and syn.request) or (fluxus and fluxus.request) or (krnl and krnl.request)
if typeof(requestFunction) ~= "function" then
    warn("❌ Executor tidak mendukung HTTP request.")
    return
end

local function safeRequest(opts)
    local success, result = pcall(function()
        return requestFunction(opts)
    end)
    return success and result or nil
end

-- Fungsi cek dan ambil instance dari API
local function getInstanceData()
    local response = safeRequest({
        Url = apiGetUrl,
        Method = "GET"
    })

    if response and response.StatusCode == 200 then
        local data = HttpService:JSONDecode(response.Body)
        return data.instanceId, data.timestamp
    end
    return nil, nil
end

-- Fungsi hapus instance dari database
local function deleteInstance()
    safeRequest({
        Url = apiDeleteUrl,
        Method = "DELETE",
        Headers = { ["Content-Type"] = "application/json" }
    })
end

-- Fungsi konversi ISO waktu ke detik (Unix timestamp)
local function isoToUnix(isoTime)
    local success, result = pcall(function()
        return DateTime.fromIsoDate(isoTime):ToUniversalTime().UnixTimestamp
    end)
    return success and result or 0
end

-- Fungsi utama
task.spawn(function()
    while true do
        local instanceId, timestamp = getInstanceData()

        if instanceId then
            if instanceId == currentInstanceId then
                game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer("Hello Guys", "All")
                break
            else
                local now = os.time()
                local posted = isoToUnix(timestamp)
                if now - posted >= 300 then -- 5 menit
                    print("🧹 Menghapus instance karena sudah lebih dari 5 menit...")
                    deleteInstance()
                else
                    print("🔁 Teleport ke instance:", instanceId)
                    TeleportService:TeleportToPlaceInstance(placeId, instanceId, player)
                end
                break
            end
        else
            print("⏳ Menunggu instance tersedia...")
        end
        task.wait(5)
    end
end)
