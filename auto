-- [Auto Joiner - Versi Diperbaiki]
repeat task.wait() until game:IsLoaded()

-- Konfigurasi
local ID_GAME_TUJUAN = 126884695634066
local URL_API = "https://backend-vercel-ashy.vercel.app/api/latest-instance.js"
local INTERVAL_PEMERIKSAAN = 30
local PERCOBAAN_MAX = 3

local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Pemain = game:GetService("Players")

-- Fungsi debug untuk print response
local function debugPrint(msg)
    print("[DEBUG] " .. os.date("%X") .. " - " .. msg)
end

local function ambilInstanceTerbaru()
    for percobaan = 1, PERCOBAAN_MAX do
        debugPrint("Percobaan ambil instance #" .. percobaan)
        
        local berhasil, respon = pcall(function()
            local url = URL_API .. "?gameId=" .. ID_GAME_TUJUAN
            debugPrint("Mengirim request ke: " .. url)
            return HttpService:GetAsync(url, true) -- Gunakan nocache
        end)
        
        if berhasil then
            debugPrint("Response API: " .. tostring(respon))
            local data = HttpService:JSONDecode(respon)
            
            -- Verifikasi struktur response
            if data and data.instanceId then
                debugPrint("Berhasil dapat instance: " .. data.instanceId)
                return data.instanceId
            else
                debugPrint("Format response tidak valid")
            end
        else
            debugPrint("Request gagal: " .. tostring(respon))
        end
        
        task.wait(2)
    end
    return nil
end

local function joinInstance(instanceId)
    debugPrint("Memulai teleport...")
    local berhasil, error = pcall(function()
        if instanceId then
            debugPrint("Teleport ke instance: " .. instanceId)
            TeleportService:TeleportToPlaceInstance(ID_GAME_TUJUAN, instanceId, Pemain.LocalPlayer)
        else
            debugPrint("Teleport ke server random")
            TeleportService:Teleport(ID_GAME_TUJUAN, Pemain.LocalPlayer)
        end
    end)
    
    if not berhasil then
        debugPrint("ERROR Teleport: " .. tostring(error))
        return false
    end
    return true
end

local function mulaiAutoJoin()
    while true do
        if game.PlaceId == ID_GAME_TUJUAN then
            debugPrint("Sudah di game tujuan")
            task.wait(INTERVAL_PEMERIKSAAN)
            continue
        end

        local instanceId = ambilInstanceTerbaru()
        
        if instanceId then
            if not joinInstance(instanceId) then
                task.wait(10)
            end
        else
            debugPrint("Gagal dapat instance, coba join random")
            joinInstance(nil)
        end
        
        task.wait(INTERVAL_PEMERIKSAAN)
    end
end

-- Enable HttpService
pcall(function()
    HttpService:SetHttpEnabled(true)
end)

debugPrint("Memulai auto joiner...")
mulaiAutoJoin()
