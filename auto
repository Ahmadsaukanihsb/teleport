local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")

-- Config
local REDIS_API_URL = "https://38fa-36-76-129-51.ngrok-free.app/api"
local PLACE_ID = 126884695634066
local CHECK_INTERVAL = 15
local MAX_CHAT_PER_INSTANCE = 3
local TELEPORT_COOLDOWN = 30
local CHAT_MESSAGE = "Halo teman-teman!"
local MAX_DISTANCE = 20 -- Maks jarak radius

-- Penyimpanan lokal untuk tracking chat dan teleport cooldown
local instanceChatCounts = {}
local lastTeleportAttempt = 0

-- HTTP request helper
local function makeHttpRequest(method, endpoint, body)
    local requestFunc = http and http.request or http_request or request
    if not requestFunc then
        warn("HTTP function not available in executor")
        return nil
    end

    local url = REDIS_API_URL .. endpoint
    local headers = { ["Content-Type"] = "application/json" }
    local requestBody = body and HttpService:JSONEncode(body) or nil

    local success, response = pcall(function()
        return requestFunc({
            Url = url,
            Method = method,
            Headers = headers,
            Body = requestBody
        })
    end)

    return success and response or nil
end

-- Fungsi teleport dengan cooldown
local function safeTeleport(instanceId)
    if os.time() - lastTeleportAttempt < TELEPORT_COOLDOWN then
        print("‚è≥ Cooldown teleport, tunggu", TELEPORT_COOLDOWN - (os.time() - lastTeleportAttempt), "detik")
        return false
    end

    lastTeleportAttempt = os.time()
    pcall(function()
        TeleportService:TeleportToPlaceInstance(PLACE_ID, instanceId, Players.LocalPlayer)
    end)
    return true
end

-- Menghitung jarak Euclidean 3D
local function getDistance(pos1, pos2)
    local dx = pos1.x - pos2.x
    local dy = pos1.y - pos2.y
    local dz = pos1.z - pos2.z
    return math.sqrt(dx*dx + dy*dy + dz*dz)
end

-- Ambil posisi player lokal
local function getLocalPlayerPosition()
    local character = Players.LocalPlayer.Character
    if not character then return nil end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return nil end
    local pos = rootPart.Position
    return { x = pos.X, y = pos.Y, z = pos.Z }
end

-- Cek apakah userId lokal ada dalam list userIds
local function isUserIdInSameInstance(userIds)
    local localUserId = Players.LocalPlayer.UserId
    for _, userId in ipairs(userIds) do
        if userId == localUserId then
            return true
        end
    end
    return false
end

-- Main loop
local function main()
    while task.wait(CHECK_INTERVAL) do
        local response = makeHttpRequest("GET", "/getInstanceId")
        if response and response.StatusCode == 200 then
            local success, data = pcall(HttpService.JSONDecode, HttpService, response.Body)
            if success and data.instanceId then
                local instanceId = data.instanceId

                -- Init counter untuk instance baru
                if not instanceChatCounts[instanceId] then
                    instanceChatCounts[instanceId] = 0
                    print("üÜï Instance baru terdeteksi:", instanceId)
                end

                if instanceId == game.JobId then
                    print("‚úÖ Berada di instance", game.JobId, "| Chat terkirim:", instanceChatCounts[game.JobId] or 0, "/", MAX_CHAT_PER_INSTANCE)

                    if instanceChatCounts[game.JobId] >= MAX_CHAT_PER_INSTANCE then
                        print("üö´ Batas chat tercapai untuk instance ini")
                    else
                        -- Ambil userId dan posisi user lain di instance ini
                        local userPosResp = makeHttpRequest("GET", "/getUserPositions?instanceId=" .. instanceId)
                        if userPosResp and userPosResp.StatusCode == 200 then
                            local successPos, dataUsers = pcall(HttpService.JSONDecode, HttpService, userPosResp.Body)
                            if successPos and dataUsers.users then
                                local localPos = getLocalPlayerPosition()
                                if not localPos then
                                    warn("‚ö†Ô∏è Gagal mendapatkan posisi lokal player")
                                else
                                    -- Cek apakah userId lokal ada di daftar user
                                    local foundLocalUser = false
                                    for _, user in ipairs(dataUsers.users) do
                                        if user.userId == Players.LocalPlayer.UserId then
                                            foundLocalUser = true
                                            break
                                        end
                                    end

                                    if not foundLocalUser then
                                        print("‚ùå UserId lokal tidak ditemukan di server ini, skip chat")
                                    else
                                        -- Cek jarak ke semua user, jika ada user lain dalam radius MAX_DISTANCE maka boleh chat
                                        local canChat = false
                                        for _, user in ipairs(dataUsers.users) do
                                            if user.userId ~= Players.LocalPlayer.UserId then
                                                if user.position then
                                                    local dist = getDistance(localPos, user.position)
                                                    if dist <= MAX_DISTANCE then
                                                        canChat = true
                                                        break
                                                    end
                                                end
                                            end
                                        end

                                        if canChat then
                                            pcall(function()
                                                TextChatService.TextChannels.RBXGeneral:SendAsync(CHAT_MESSAGE)
                                                instanceChatCounts[game.JobId] = (instanceChatCounts[game.JobId] or 0) + 1
                                                print("üí¨ Mengirim chat (", instanceChatCounts[game.JobId], "/", MAX_CHAT_PER_INSTANCE, ")")
                                            end)
                                        else
                                            print("üõë Tidak ada user lain dalam radius " .. MAX_DISTANCE .. ", hentikan chat")
                                        end
                                    end
                                end
                            else
                                warn("Gagal parsing data posisi user dari server")
                            end
                        else
                            warn("Gagal mendapatkan posisi user dari server")
                        end
                    end
                else
                    print("üîÑ Instance berbeda, teleporting ke", instanceId)
                    -- Reset counter instance lama
                    if instanceChatCounts[game.JobId] then
                        instanceChatCounts[game.JobId] = nil
                    end

                    if safeTeleport(instanceId) then
                        task.wait(5)
                    end
                end
            else
                warn("Gagal parsing data instanceId:", response.Body)
            end
        else
            warn("Gagal mendapatkan instanceId dari server")
        end
    end
end

-- Jalankan script
local success, err = pcall(main)
if not success then
    warn("Script error:", err)
end
