local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

local myPlayer = Players.LocalPlayer
local backendUrl = "https://backend-vercel-ashy.vercel.app/api/register.js" -- endpoint backend yang mengembalikan list username + instanceId
local checkInterval = 10 -- detik cek instance baru
local currentInstanceId = nil
local targetUsername = nil

-- Fungsi dapatkan list username + instanceId dari backend
local function getUsersInstances()
    local success, result = pcall(function()
        local response = HttpService:GetAsync(backendUrl)
        return HttpService:JSONDecode(response)
    end)
    if success and type(result) == "table" then
        return result
    else
        return {}
    end
end

-- Fungsi cari username dan instanceId yang cocok dari list
local function findTargetUserInstance(usersInstances)
    for _, userData in ipairs(usersInstances) do
        if userData.username == myPlayer.Name then
            return userData.instanceId
        end
    end
    return nil
end

-- Fungsi cek apakah player lain dalam radius tertentu
local function isPlayerNearby(radius)
    local myCharacter = myPlayer.Character
    if not myCharacter or not myCharacter.PrimaryPart then return false end
    local myPos = myCharacter.PrimaryPart.Position

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= myPlayer and player.Character and player.Character.PrimaryPart then
            local distance = (player.Character.PrimaryPart.Position - myPos).Magnitude
            if distance <= radius then
                return true
            end
        end
    end
    return false
end

-- Fungsi chat jika satu server dan tidak ada player dekat
local function chatIfAllowed()
    if not myPlayer.Character or not myPlayer.Character.PrimaryPart then return end

    -- Cek apakah target user ada di server (bisa sesuaikan dengan myPlayer.Name atau username lain)
    local targetPlayer = Players:FindFirstChild(targetUsername)
    if targetPlayer and targetPlayer.Character and targetPlayer.Character.PrimaryPart then
        if not isPlayerNearby(20) then
            myPlayer:Chat("Hello, I'm in the same server!")
        end
    end
end

-- Fungsi teleport ke instance baru
local function teleportToInstance(newInstanceId)
    local placeId = tonumber(newInstanceId) or 0
    if placeId > 0 then
        TeleportService:Teleport(placeId, myPlayer)
    else
        print("InstanceId invalid:", newInstanceId)
    end
end

-- Loop utama
spawn(function()
    while true do
        local usersInstances = getUsersInstances()
        local instanceId = findTargetUserInstance(usersInstances)
        
        if instanceId and instanceId ~= currentInstanceId then
            currentInstanceId = instanceId
            targetUsername = myPlayer.Name  -- target username disamakan dengan player sendiri
            print("Instance terbaru untuk " .. targetUsername .. ": " .. currentInstanceId)
            teleportToInstance(currentInstanceId)
        end

        wait(checkInterval)
    end
end)

-- Loop chat
RunService.Heartbeat:Connect(function()
    chatIfAllowed()
    wait(5)
end)
