local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer
local currentInstanceId = game.JobId

local BACKEND_LATEST_USER_URL = "https://backend-vercel-ashy.vercel.app/api/latest-user.js"
local TARGET_RADIUS = 20
local CHAT_MESSAGE = "dsadsadsa!"

local isChatting = false
local cachedUsername, cachedInstanceId
local lastFetch = 0
local FETCH_COOLDOWN = 15 -- detik

-- Fungsi fetch dengan syn.request
local function fetchLatestUser()
    if (tick() - lastFetch) < FETCH_COOLDOWN and cachedInstanceId then
        return cachedUsername, cachedInstanceId
    end

    local success, response = pcall(function()
        return syn.request({
            Url = BACKEND_LATEST_USER_URL,
            Method = "GET"
        })
    end)

    if success and response.StatusCode == 200 then
        local data = HttpService:JSONDecode(response.Body)
        cachedUsername = data.username
        cachedInstanceId = data.instanceId
        lastFetch = tick()
        return cachedUsername, cachedInstanceId
    else
        warn("Failed to fetch latest user: " .. tostring(response and response.StatusCode or response))
        return nil, nil
    end
end

local function tryChat(targetUsername)
    if isChatting then return end

    local targetPlayer = Players:FindFirstChild(targetUsername)
    if not targetPlayer then return end

    local distance = (player.Character and targetPlayer.Character)
        and (player.Character.HumanoidRootPart.Position - targetPlayer.Character.HumanoidRootPart.Position).Magnitude
        or math.huge

    if distance <= TARGET_RADIUS then
        isChatting = true
        game:GetService("ReplicatedStorage"):WaitForChild("DefaultChatSystemChatEvents")
            :WaitForChild("SayMessageRequest"):FireServer(CHAT_MESSAGE, "All")
        task.delay(5, function()
            isChatting = false
        end)
    end
end

task.spawn(function()
    while true do
        local targetUsername, targetInstanceId = fetchLatestUser()
        if targetInstanceId and targetInstanceId ~= currentInstanceId and targetUsername ~= player.Name then
            print("Teleporting to latest instance:", targetInstanceId, "target username:", targetUsername)
            TeleportService:TeleportToPlaceInstance(game.PlaceId, targetInstanceId, player)
            return
        elseif targetInstanceId == currentInstanceId then
            tryChat(targetUsername)
        end
        task.wait(10)
    end
end)
