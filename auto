-- [Auto Joiner - Versi Final]
repeat task.wait() until game:IsLoaded()

-- Konfigurasi
local ID_GAME_TUJUAN = 126884695634066
local URL_API = "https://backend-vercel-ashy.vercel.app/api/latest-instance.js"
local INTERVAL_PEMERIKSAAN = 10 -- Diperpendek dari 30 detik
local PERCOBAAN_MAX = 3
local TERAKHIR_DIPERIKSA = 0

local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Pemain = game:GetService("Players")

-- Fungsi debug
local function debugPrint(msg)
    print("[DEBUG] " .. os.date("%X") .. " - " .. msg)
end

-- Fungsi untuk cek instance terbaru
local function ambilInstanceTerbaru()
    for percobaan = 1, PERCOBAAN_MAX do
        debugPrint("Percobaan ambil instance #" .. percobaan)
        
        local berhasil, respon = pcall(function()
            local url = URL_API .. "?gameId=" .. ID_GAME_TUJUAN
            debugPrint("Mengirim request ke: " .. url)
            return HttpService:GetAsync(url, true)
        end)
        
        if berhasil then
            debugPrint("Response API: " .. tostring(respon))
            local data = HttpService:JSONDecode(respon)
            
            if data and data.instanceId then
                debugPrint("Berhasil dapat instance: " .. data.instanceId)
                return data.instanceId
            else
                debugPrint("Format response tidak valid")
            end
        else
            debugPrint("Request gagal: " .. tostring(respon))
        end
        
        task.wait(2)
    end
    return nil
end

-- Fungsi untuk join instance
local function joinInstance(instanceId)
    debugPrint("Memulai teleport ke instance: " .. (instanceId or "RANDOM"))
    local berhasil, error = pcall(function()
        if instanceId then
            TeleportService:TeleportToPlaceInstance(ID_GAME_TUJUAN, instanceId, Pemain.LocalPlayer)
        else
            TeleportService:Teleport(ID_GAME_TUJUAN, Pemain.LocalPlayer)
        end
    end)
    
    if not berhasil then
        debugPrint("ERROR Teleport: " .. tostring(error))
        return false
    end
    return true
end

-- Fungsi utama
local function mulaiAutoJoin()
    local instanceSaatIni = game.JobId
    local instanceTerbaru = ambilInstanceTerbaru()
    
    -- Jika sudah di game tujuan, tapi bukan instance terbaru
    if game.PlaceId == ID_GAME_TUJUAN then
        if instanceTerbaru and instanceTerbaru ~= instanceSaatIni then
            debugPrint("Ada instance lebih baru! ("..instanceTerbaru..")")
            if not joinInstance(instanceTerbaru) then
                task.wait(5)
            end
        else
            debugPrint("Sudah di instance terbaru ("..instanceSaatIni..")")
        end
    else
        -- Jika tidak di game tujuan
        if instanceTerbaru then
            joinInstance(instanceTerbaru)
        else
            joinInstance(nil)
        end
    end
    
    -- Jadwalkan pemeriksaan ulang
    task.wait(INTERVAL_PEMERIKSAAN)
    mulaiAutoJoin() -- Rekursif
end

-- Enable HttpService
pcall(function()
    HttpService:SetHttpEnabled(true)
    debugPrint("HTTP Service diaktifkan")
end)

debugPrint("Memulai auto joiner...")
mulaiAutoJoin()
