local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")
local UserInputService = game:GetService("UserInputService")

-- Configuration
local REDIS_API_URL = "https://api-beta-mocha-45.vercel.app/api"
local PLACE_ID = 126884695634066
local CHECK_INTERVAL = 15
local CHAT_MESSAGE = "dsadadsadas"

-- Delta-optimized HTTP request
local function makeHttpRequest(method, endpoint, body)
    local requestFunc = http and http.request or http_request or request
    if not requestFunc then return nil end
    
    local success, response = pcall(function()
        return requestFunc({
            Url = REDIS_API_URL..endpoint,
            Method = method,
            Headers = {["Content-Type"] = "application/json"},
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end)
    
    return success and response or nil
end

-- Improved button clicker for exact "Accept" button
local function clickAcceptButton()
    local gui = Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")
    if not gui then return false end

    -- First try to find exact "Accept" text button
    for _, screen in ipairs(gui:GetChildren()) do
        if screen:IsA("ScreenGui") and screen.Enabled then
            for _, descendant in ipairs(screen:GetDescendants()) do
                -- Check for TextButton with exact "Accept" text
                if descendant:IsA("TextButton") and descendant.Text == "Accept" then
                    if descendant.Visible and descendant.Active then
                        -- Try to fire click event directly
                        local clickEvent = descendant:FindFirstChild("MouseButton1Click")
                        if clickEvent then
                            pcall(clickEvent.Fire, clickEvent)
                            return true
                        end
                        
                        -- Fallback to mouse click simulation
                        pcall(function()
                            local pos = descendant.AbsolutePosition
                            local size = descendant.AbsoluteSize
                            local center = pos + size/2
                            
                            -- Double click to ensure registration
                            for _ = 1, 2 do
                                UserInputService:SendMouseButtonEvent(center.X, center.Y, 0, true, game, 1)
                                task.wait(0.05)
                                UserInputService:SendMouseButtonEvent(center.X, center.Y, 0, false, game, 1)
                                task.wait(0.1)
                            end
                        end)
                        return true
                    end
                end
            end
        end
    end
    return false
end

-- Main function with better button handling
local function main()
    while task.wait(CHECK_INTERVAL) do
        local response = makeHttpRequest("GET", "/getInstanceId")
        if response and response.StatusCode == 200 then
            local success, data = pcall(HttpService.JSONDecode, HttpService, response.Body)
            if success and data.instanceId then
                if data.instanceId == game.JobId then
                    -- In correct instance
                    pcall(function()
                        local channel = TextChatService.TextChannels.RBXGeneral
                        if channel then channel:SendAsync(CHAT_MESSAGE) end
                    end)
                    
                    -- Enhanced button clicking with retries
                    for i = 1, 3 do  -- Try 3 times with delays
                        if clickAcceptButton() then break end
                        task.wait(0.5)
                    end
                else
                    -- Teleport to new instance
                    pcall(function()
                        TeleportService:TeleportToPlaceInstance(PLACE_ID, data.instanceId, Players.LocalPlayer)
                        task.wait(10)  -- Wait for teleport
                    end)
                end
            end
        end
    end
end

-- Start with error protection
local success, err = pcall(main)
if not success then
    warn("Script error:", err)
    -- Try to restart after delay
    task.wait(30)
    pcall(main)
end
