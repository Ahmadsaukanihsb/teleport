
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Konfigurasi
local REDIS_API_URL = "https://api-beta-mocha-45.vercel.app/api"
local PLACE_ID = 126884695634066
local CHECK_INTERVAL = 15
local INSTANCE_TIMEOUT = 120
local CHAT_MESSAGE = "dsadadsadas"
local GIFT_COOLDOWN = 5
local PLAYER_DETECTION_RADIUS = 20

local lastGiftCheck = 0

-- Fungsi cek player lain
local function isPlayerNearby()
    local localPlayer = Players.LocalPlayer
    if not localPlayer or not localPlayer.Character or not localPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return false
    end

    local localPosition = localPlayer.Character.HumanoidRootPart.Position

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local distance = (player.Character.HumanoidRootPart.Position - localPosition).Magnitude
            if distance <= PLAYER_DETECTION_RADIUS then
                return true
            end
        end
    end

    return false
end

-- HTTP request
local function makeHttpRequest(method, endpoint, body)
    local requestFunc = http and http.request or http_request or request
    if not requestFunc then
        warn("HTTP function not available in Delta")
        return nil
    end

    local url = REDIS_API_URL .. endpoint
    local success, response = pcall(function()
        return requestFunc({
            Url = url,
            Method = method,
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end)

    return success and response or nil
end

-- Fungsi klik tombol konfirmasi
local function clickAcceptButton()
    local gui = Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")
    if not gui then return false end

    local targetNames = {"accept", "join", "confirm", "ok"}

    for _, screen in ipairs(gui:GetChildren()) do
        if screen:IsA("ScreenGui") and screen.Enabled then
            for _, descendant in ipairs(screen:GetDescendants()) do
                if (descendant:IsA("TextButton") or descendant:IsA("ImageButton")) then
                    local lowerName = string.lower(descendant.Name)
                    for _, target in ipairs(targetNames) do
                        if string.find(lowerName, target) then
                            if descendant.Visible and descendant.Active then
                                local clickEvent = descendant:FindFirstChild("MouseButton1Click")
                                if clickEvent then
                                    pcall(clickEvent.Fire, clickEvent)
                                    return true
                                end

                                pcall(function()
                                    local absPos = descendant.AbsolutePosition
                                    local absSize = descendant.AbsoluteSize
                                    local center = absPos + absSize / 2
                                    UserInputService:SendMouseButtonEvent(center.X, center.Y, 0, true, game, 1)
                                    task.wait(0.1)
                                    UserInputService:SendMouseButtonEvent(center.X, center.Y, 0, false, game, 1)
                                end)
                                return true
                            end
                        end
                    end
                end
            end
        end
    end
    return false
end

-- Debug UI Gift
local function debugGiftGui()
    local gui = Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")
    if not gui then return end

    local giftFrame = gui:FindFirstChild("Gift_Notification", true)
    if not giftFrame then
        print("Tidak menemukan Gift_Notification")
        return
    end

    print("---- STRUKTUR GIFT GUI ----")
    for _, d in ipairs(giftFrame:GetDescendants()) do
        if d:IsA("TextButton") or d:IsA("ImageButton") then
            print("Tombol ditemukan:", d.Name, "Text:", d.Text or "N/A", "Path:", d:GetFullName())
        end
    end
end

-- Auto collect gift
local function collectGifts()
    if os.time() - lastGiftCheck < GIFT_COOLDOWN then return end
    lastGiftCheck = os.time()

    local gui = Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")
    if not gui then 
        print("‚ùå PlayerGui tidak ditemukan")
        return false 
    end

    -- Cari semua frame gift yang mungkin ada (untuk handle multiple gifts)
    local giftFrames = {}
    for _, screen in ipairs(gui:GetDescendants()) do
        if screen:IsA("Frame") and screen.Name == "Gift_Notification" then
            table.insert(giftFrames, screen)
        end
    end

    if #giftFrames == 0 then
        print("‚ùå Tidak ada gift notification yang ditemukan")
        return false
    end

    local successCount = 0
    
    for _, giftFrame in ipairs(giftFrames) do
        -- Cari tombol Accept dalam frame gift
        local acceptButton = giftFrame:FindFirstChild("Accept", true)
        
        if acceptButton and acceptButton:IsA("TextButton") and acceptButton.Visible and acceptButton.Active then
            print("‚úÖ Tombol Accept ditemukan:", acceptButton:GetFullName())
            
            -- Method 1: Coba fire event klik langsung
            local clickEvent = acceptButton:FindFirstChildOfClass("RemoteEvent") or 
                             acceptButton:FindFirstChild("MouseButton1Click")
            
            if clickEvent then
                pcall(function()
                    clickEvent:Fire()
                    successCount = successCount + 1
                    print("üéÅ Gift diterima (via event)")
                end)
            else
                -- Method 2: Gunakan virtual click sebagai fallback
                pcall(function()
                    local absPos = acceptButton.AbsolutePosition
                    local absSize = acceptButton.AbsoluteSize
                    local centerX = absPos.X + absSize.X/2
                    local centerY = absPos.Y + absSize.Y/2
                    
                    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 1)
                    task.wait(0.1)
                    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 1)
                    successCount = successCount + 1
                    print("üéÅ Gift diterima (via virtual click)")
                end)
            end
            
            -- Tunggu sebentar antara setiap gift
            task.wait(0.5)
        else
            print("‚ùå Tombol Accept tidak aktif atau tidak ditemukan dalam frame")
        end
    end

    return successCount > 0
end


-- Fungsi utama
local function main()
    while task.wait(CHECK_INTERVAL) do
        local response = makeHttpRequest("GET", "/getInstanceId")
        if response and response.StatusCode == 200 then
            local success, data = pcall(HttpService.JSONDecode, HttpService, response.Body)
            if success and data.instanceId then
                if data.instanceId == game.JobId then
                    print("‚úÖ Instance cocok, menjalankan tugas...")

                    collectGifts()

                    if isPlayerNearby() then
                        print("üë• Player lain terdeteksi - skip chat")
                    else
                        pcall(function()
                            TextChatService.TextChannels.RBXGeneral:SendAsync(CHAT_MESSAGE)
                        end)
                        clickAcceptButton()
                    end
                else
                    print("‚ùå Berada di instance salah, teleporting...")
                    pcall(function()
                        TeleportService:TeleportToPlaceInstance(PLACE_ID, data.instanceId, Players.LocalPlayer)
                    end)
                end
            else
                warn("Gagal parsing data instanceId:", response.Body)
            end
        else
            warn("Gagal mendapatkan instanceId dari server")
        end
    end
end

-- Jalankan script
local success, err = pcall(main)
if not success then
    warn("Script error:", err)
end
