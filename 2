local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local BACKEND_URL = "https://backend-tau-three-32.vercel.app/api/instanceUser"
local RETRY_LIMIT = 5
local RETRY_DELAY = 3

local function postData(data)
    local jsonData = HttpService:JSONEncode(data)
    local headers = {["Content-Type"] = "application/json"}
    for i = 1, RETRY_LIMIT do
        local success, response = pcall(function()
            return HttpService:RequestAsync({
                Url = BACKEND_URL,
                Method = "POST",
                Headers = headers,
                Body = jsonData
            })
        end)
        if success and response.StatusCode >= 200 and response.StatusCode < 300 then
            print("[Logger] Sent data to backend")
            return true
        else
            warn("[Logger] Failed attempt "..i..", retrying...")
            task.wait(RETRY_DELAY)
        end
    end
    return false
end

local function sendLogger()
    local data = {
        username = player.Name,
        userId = player.UserId,
        instanceId = game.JobId,
        timestamp = os.time()
    }
    return postData(data)
end

-- Kirim data saat karakter siap
if player.Character and player.Character.PrimaryPart then
    sendLogger()
else
    player.CharacterAdded:Connect(function()
        sendLogger()
    end)
end
