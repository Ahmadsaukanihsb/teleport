local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local UserInputService = game:GetService("UserInputService")

local API_URL = "https://backend-vercel-ashy.vercel.app/api/instance.js" -- ganti URL backend yang bisa GET latest instance
local CHECK_INTERVAL = 10
local DEBUG_MODE = true

local lastInstanceId = nil
local stopScript = false

local function log(msg)
    if DEBUG_MODE then
        print("[AutoJoiner] " .. msg)
    end
end

-- Fungsi untuk mengambil instance terbaru dari backend
local function getLatestInstance()
    local success, response = pcall(function()
        -- NOTE: instance.js menerima POST, tapi kita butuh endpoint GET untuk ambil latest instance
        -- Buat endpoint terpisah di backend untuk GET latest instance dari sorted set 'recent_instances'
        -- Misal: GET /latest-instance
        return HttpService:GetAsync("https://your-backend-url/latest-instance") 
    end)
    
    if success then
        local data = HttpService:JSONDecode(response)
        if data and data.instanceId then
            return data.instanceId
        else
            log("Response JSON missing instanceId")
        end
    else
        log("Failed to get latest instance: " .. tostring(response))
    end
    return nil
end

local function teleportToInstance(instanceId)
    if not instanceId then return false end
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return false end

    log("Teleporting to instance: " .. instanceId)
    local success, err = pcall(function()
        TeleportService:TeleportToPlaceInstance(game.PlaceId, instanceId, localPlayer)
    end)
    if not success then
        log("Teleport failed: " .. tostring(err))
    end
    return success
end

local function mainLoop()
    while not stopScript do
        local newInstance = getLatestInstance()
        if newInstance and newInstance ~= lastInstanceId then
            lastInstanceId = newInstance
            teleportToInstance(newInstance)
        end
        task.wait(CHECK_INTERVAL)
    end
end

local function init()
    log("Initializing AutoJoiner...")
    repeat task.wait() until Players.LocalPlayer

    lastInstanceId = getLatestInstance()
    if lastInstanceId then
        log("Starting instance: " .. lastInstanceId)
    else
        log("Could not fetch initial instance.")
    end

    task.spawn(mainLoop)
end

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.End then
        stopScript = true
        log("Script manually stopped.")
    end
end)

init()
log("AutoJoiner loaded. Press End to stop.")
